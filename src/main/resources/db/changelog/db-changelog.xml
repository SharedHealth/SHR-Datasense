<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd">
    <!--Add change tags here-->

    <changeSet id="ict4h-atomfeed-client-1" context="setup" author="ict4h">
        <createTable tableName="markers">
            <column name="feed_uri" type="varchar(255)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="last_read_entry_id" type="varchar(255)"/>
            <column name="feed_uri_for_last_read_entry" type="varchar(255)"/>
        </createTable>
    </changeSet>
    <changeSet id="ict4h-atomfeed-client-2" context="setup" author="ict4h">
        <createTable tableName="failed_events">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="feed_uri" type="varchar(255)"/>
            <column name="failed_at" type="timestamp"/>
            <!-- TODO: change to CLOB -->
            <column name="error_message" type="varchar(4000)"/>
            <column name="event_id" type="varchar(255)"/>
            <!-- TODO: change to CLOB -->
            <column name="event_content" type="varchar(4000)"/>
            <column name="error_hash_code" type="int"/>
            <column name="title" type="varchar(255)"></column>
        </createTable>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20141029-1432" author="sharedhealth" context="setup">
        <comment>creating quartz tables</comment>
        <sqlFile path="classpath:/db/changelog/tables_for_quartz.sql"/>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20141031-1739" author="sharedhealth" context="setup">
        <modifyDataType columnName="event_content"
                        newDataType="TEXT"
                        tableName="failed_events"/>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20141106-1214" author="sharedhealth" context="setup">
        <comment>creating location table</comment>
        <createTable tableName="location">
            <column name="location_id" type="varchar(20)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(100)"/>
            <column name="type" type="varchar(20)"/>
            <column name="level" type="int"/>
            <column name="parent_id" type="varchar(20)"/>
            <column name="code" type="varchar(20)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20141106-1244" author="sharedhealth" context="setup">
        <comment>add foreign key constraints for location table</comment>
        <addForeignKeyConstraint baseColumnNames="parent_id"
                                 baseTableName="location"
                                 constraintName="parent_location_fk"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="location_id"
                                 referencedTableName="location"/>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20141106-1245" author="sharedhealth" context="setup">
        <comment>creating patient table</comment>
        <createTable tableName="patient">
            <column name="patient_hid" type="varchar(20)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="dob" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="gender" type="varchar(2)"/>
            <column name="present_location_id" type="varchar(20)"/>
        </createTable>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20141106-1249" author="sharedhealth" context="setup">
        <comment>creating facility table</comment>
        <createTable tableName="facility">
            <column name="facility_id" type="varchar(20)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(50)"/>
            <column name="type" type="varchar(30)"/>
            <column name="location_id" type="varchar(20)"/>
        </createTable>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20141106-1930" author="sharedhealth" context="setup">
        <comment>creating encounter table</comment>
        <createTable tableName="encounter">
            <column name="encounter_id" type="varchar(50)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="encounter_datetime" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="encounter_type" type="varchar(30)"/>
            <column name="visit_type" type="varchar(30)"/>
            <column name="patient_hid" type="varchar(20)"/>
            <column name="patient_age_years" type="int"/>
            <column name="patient_age_months" type="int"/>
            <column name="patient_age_days" type="int"/>
            <column name="encounter_location_id" type="varchar(20)"/>
            <column name="facility_id" type="varchar(20)"/>
        </createTable>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20141110-1158" author="sharedhealth" context="setup">
        <comment>creating diagnosis table</comment>
        <createTable tableName="diagnosis">
            <column name="diagnosis_id" type="int" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="patient_hid" type="varchar(20)"/>
            <column name="encounter_id" type="varchar(50)"/>
            <column name="diagnosis_datetime" type="timestamp"/>
            <column name="diagnosis_code" type="varchar(10)"/>
            <column name="diagnosis_concept_id" type="varchar(50)"/>
            <column name="diagnosis_status" type="varchar(20)"/>
        </createTable>
    </changeSet>

    <changeSet id="sharedhealth-datasense-20150102-1204" author="sharedhealth" context="setup">
        <comment>adding column dhis_org_unit_uid</comment>
        <addColumn tableName="facility">
            <column name="dhis_org_unit_uid" type="varchar(15)"></column>
        </addColumn>
    </changeSet>

    <changeSet id="sharedhealth-datasense-20150113-0455" author="sharedhealth" context="setup">
        <comment>modifying all timestamp datatype to datetime</comment>
        <modifyDataType columnName="dob"
                        newDataType="datetime"
                        tableName="patient"/>
        <modifyDataType columnName="failed_at"
                        newDataType="datetime"
                        tableName="failed_events"/>
        <modifyDataType columnName="encounter_datetime"
                        newDataType="datetime"
                        tableName="encounter"/>
        <modifyDataType columnName="diagnosis_datetime"
                        newDataType="datetime"
                        tableName="diagnosis"/>
    </changeSet>

    <changeSet id="aggregate-query-service-201501020718" author="ict4h" context="setup">
        <createTable tableName="aqs_task">
            <column name="aqs_task_id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="aqs_config_path" type="varchar(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="task_status" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="aggregate-query-service-201501121119" author="sharedhealth" context="setup">
        <addColumn tableName="aqs_task">
            <column name="results" type="text"/>
        </addColumn>
        <addColumn tableName="aqs_task">
            <column name="input_parameters" type="text"/>
        </addColumn>
        <addColumn tableName="aqs_task">
            <column name="query_config" type="text"/>
        </addColumn>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150114-1529" author="sharedhealth" context="setup">
        <comment>creating medication table</comment>
        <createTable tableName="medication">
            <column name="medication_id" type="int" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="patient_hid" type="varchar(20)"/>
            <column name="encounter_id" type="varchar(50)"/>
            <column name="name" type="varchar(50)"/>
            <column name="drug_id" type="varchar(50)"/>
            <column name="code" type="varchar(10)"/>
            <column name="concept_id" type="varchar(50)"/>
            <column name="datetime" type="datetime"/>
            <column name="status" type="varchar(2)"/>
        </createTable>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150120-1245" author="sharedhealth" context="setup">
        <comment>creating observation table</comment>
        <createTable tableName="observation">
            <column name="observation_id" type="int" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="patient_hid" type="varchar(20)"/>
            <column name="encounter_id" type="varchar(50)"/>
            <column name="code" type="varchar(10)"/>
            <column name="concept_id" type="varchar(50)"/>
            <column name="datetime" type="datetime"/>
            <column name="parent_id" type="varchar(50)"/>
            <column name="value" type="varchar(100)"/>
            <column name="uuid" type="varchar(50)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="parent_id"
                                 baseTableName="observation"
                                 constraintName="parent_observation_fk"
                                 onDelete="CASCADE"
                                 onUpdate="CASCADE"
                                 referencedColumnNames="uuid"
                                 referencedTableName="observation"/>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150120-1448" author="sharedhealth" context="setup">
        <comment>adding column uuid to diagnosis and medication</comment>
        <addColumn tableName="diagnosis">
            <column name="uuid" type="varchar(50)"/>
        </addColumn>
        <addColumn tableName="medication">
            <column name="uuid" type="varchar(50)"/>
        </addColumn>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150122-1232" author="sharedhealth" context="setup" dbms="MySQL">
        <comment>populating uuid columns for diagnosis and medication.</comment>
        <update tableName="diagnosis">
            <column name="uuid" valueComputed="uuid()"/>
        </update>
        <update tableName="medication">
            <column name="uuid" valueComputed="uuid()"/>
        </update>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150121-1802" author="sharedhealth" context="setup">
        <comment>adding unique and not null constraints to diagnosis and medication.</comment>
        <addUniqueConstraint columnNames="uuid"
                             tableName="diagnosis"/>
        <addNotNullConstraint columnName="uuid"
                              tableName="diagnosis" columnDataType="varchar(50)"/>
        <addUniqueConstraint columnNames="uuid"
                             tableName="medication"/>
        <addNotNullConstraint columnName="uuid"
                              tableName="medication" columnDataType="varchar(50)"/>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150127-1049" author="sharedhealth" context="setup">
        <comment>creating tr concept table</comment>
        <createTable tableName="concept">
            <column name="concept_uuid" type="varchar(50)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(50)" />
            <column name="class" type="varchar(50)" />
        </createTable>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150127-1059" author="sharedhealth" context="setup">
        <comment>creating tr reference term table</comment>
        <createTable tableName="reference_term">
            <column name="reference_term_uuid" type="varchar(50)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(50)" />
            <column name="code" type="varchar(50)" />
            <column name="source" type="varchar(50)" />
        </createTable>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150127-1060" author="sharedhealth" context="setup">
        <comment>creating tr reference term map table</comment>
        <createTable tableName="reference_term_map">
            <column name="reference_term_map_id" type="int" autoIncrement="true">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="concept_uuid" type="varchar(50)" />
            <column name="reference_term_uuid" type="varchar(50)" />
            <column name="relationship_type" type="varchar(50)" />
        </createTable>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150130-1635" author="sharedhealth" context="setup">
        <comment>creating patient death details table</comment>
        <createTable tableName="patient_death_details">
            <column name="id" type="int" autoIncrement="true">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="patient_hid" type="varchar(50)" />
            <column name="encounter_id" type="varchar(50)" />
            <column name="date_of_death" type="datetime" />
            <column name="cause_concept_uuid" type="varchar(50)" />
            <column name="cause_code" type="varchar(50)" />
            <column name="circumstances_of_death" type="varchar(50)" />
            <column name="patient_age_years" type="int" />
            <column name="patient_age_months" type="int" />
            <column name="patient_age_days" type="int" />
            <column name="uuid" type="varchar(50)" />
        </createTable>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150130-1653" author="sharedhealth" context="setup">
            <comment>creating tr drug table</comment>
            <createTable tableName="drug">
                <column name="drug_uuid" type="varchar(50)" />
                <column name="concept_uuid" type="varchar(50)" />
                <column name="name" type="varchar(255)" />
                <column name="reference_term_uuid" type="varchar(255)" />
            </createTable>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150203-1151" author="sharedhealth" context="setup">
        <comment>alter medication table</comment>
        <dropColumn columnName="name" tableName="medication"/>
        <dropColumn columnName="code" tableName="medication"/>
        <dropColumn columnName="concept_id" tableName="medication"/>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150203-1208" author="sharedhealth" context="setup">
        <modifyDataType columnName="circumstances_of_death"
                newDataType="varchar(500)"
                tableName="patient_death_details"/>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150204-1635" author="sharedhealth" context="setup">
        <comment>creating patient procedure details table</comment>
        <createTable tableName="procedures">
            <column name="procedure_id" type="int" autoIncrement="true">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="patient_hid" type="varchar(50)" />
            <column name="encounter_id" type="varchar(50)" />
            <column name="date" type="datetime" />
            <column name="start_date" type="datetime" />
            <column name="end_date" type="datetime" />
            <column name="procedure_uuid" type="varchar(50)" />
            <column name="procedure_code" type="varchar(50)" />
            <column name="diagnosis_uuid" type="varchar(50)" />
            <column name="diagnosis_code" type="varchar(50)" />
        </createTable>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150219-1433" author="sharedhealth" context="setup">
        <comment>creating provider table</comment>
        <createTable tableName="provider">
            <column name="id" type="varchar(20)">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="name" type="varchar(50)" />
            <column name="facility_id" type="varchar(50)" />
        </createTable>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150423-1351" author="sanjana" context="setup">
        <comment>Increasing the concept name column size</comment>
        <modifyDataType columnName="name"
                        newDataType="varchar(255)"
                        tableName="concept"/>

    </changeSet>
    <changeSet id="sharedhealth-datasense-20150427-1411" author="sanjana" context="setup">
        <comment>Adding created timestamp column to encounter tables</comment>
        <addColumn tableName="encounter">
            <column name="created_at" type="timestamp" defaultValueComputed="now()"/>
        </addColumn>
        <addColumn tableName="diagnosis">
            <column name="created_at" type="timestamp" defaultValueComputed="now()"/>
        </addColumn>
        <addColumn tableName="medication">
            <column name="created_at" type="timestamp" defaultValueComputed="now()"/>
        </addColumn>
        <addColumn tableName="observation">
            <column name="created_at" type="timestamp" defaultValueComputed="now()"/>
        </addColumn>
        <addColumn tableName="procedures">
            <column name="created_at" type="timestamp" defaultValueComputed="now()"/>
        </addColumn>
        <addColumn tableName="patient_death_details">
            <column name="created_at" type="timestamp" defaultValueComputed="now()"/>
        </addColumn>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150428-1111" author="utsab">
        <comment>Adding metadata columns to concept table</comment>
        <addColumn tableName="concept">
            <column name="created_at" type="datetime" defaultValueComputed="now()"/>
            <column name="updated_at" type="datetime" defaultValueComputed="now()"/>
        </addColumn>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150428-1130" author="utsab">
        <comment>Adding metadata columns to reference_term table</comment>
        <addColumn tableName="reference_term">
            <column name="created_at" type="datetime" defaultValueComputed="now()"/>
            <column name="updated_at" type="datetime" defaultValueComputed="now()"/>
        </addColumn>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150428-1133" author="utsab">
        <comment>Adding metadata columns to drug table</comment>
        <addColumn tableName="drug">
            <column name="created_at" type="datetime" defaultValueComputed="now()"/>
            <column name="updated_at" type="datetime" defaultValueComputed="now()"/>
        </addColumn>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150428-1135" author="utsab">
        <comment>Adding metadata column to reference_term_map table</comment>
        <addColumn tableName="reference_term_map">
            <column name="created_at" type="datetime" defaultValueComputed="now()"/>
        </addColumn>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150428-1137" author="utsab">
        <comment>Adding metadata column to facility table</comment>
        <addColumn tableName="facility">
            <column name="created_at" type="datetime" defaultValueComputed="now()"/>
        </addColumn>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150428-1138" author="utsab">
        <comment>Adding metadata column to location table</comment>
        <addColumn tableName="location">
            <column name="created_at" type="datetime" defaultValueComputed="now()"/>
        </addColumn>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150428-1139" author="utsab">
        <comment>Adding metadata column to provider table</comment>
        <addColumn tableName="provider">
            <column name="created_at" type="datetime" defaultValueComputed="now()"/>
        </addColumn>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150508-1900" author="angshu">
        <comment>Change reference_term.name size to varchar 255</comment>
        <modifyDataType tableName="reference_term" columnName="name" newDataType="varchar(255)" />
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150521-1550" author="sanjana">
        <comment>Change facility.type size to varchar 255</comment>
        <modifyDataType tableName="facility" columnName="type" newDataType="varchar(255)" />
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150529-1205" author="angshu" context="setup">
        <comment>creating mapping table for datasense report to dhis2 datasets</comment>
        <createTable tableName="dhis_dataset_map">
            <column name="id" type="int" autoIncrement="true">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="name" type="varchar(255)" />
            <column name="config_file" type="varchar(255)" />
            <column name="dataset_id" type="varchar(20)" />
            <column name="dataset_name" type="varchar(255)" />
            <column name="date_created" type="datetime" defaultValueComputed="CURRENT_TIMESTAMP" />
        </createTable>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150530-1253" author="angshu" context="setup">
        <comment>creating mapping table for datasense facility to dhis2 org unit</comment>
        <createTable tableName="dhis_orgunit_map">
            <column name="id" type="int" autoIncrement="true">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="facility_id" type="varchar(20)" />
            <column name="org_unit_id" type="varchar(20)" />
            <column name="org_unit_name" type="varchar(255)" />
            <column name="date_created" type="datetime" defaultValueComputed="CURRENT_TIMESTAMP" />
        </createTable>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150602-1405" author="angshu" context="setup">
        <comment>adding column dhis_dataset_map.period_type</comment>
        <addColumn tableName="dhis_dataset_map">
            <column name="period_type" type="varchar(25)"></column>
        </addColumn>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150619-1129" author="sharedhealth" context="setup">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="immunization_reason"/>
            </not>
        </preConditions>
        <comment>creating immunization reason table</comment>
        <createTable tableName="immunization_reason">
            <column name="immunization_reason_id" type="int" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="patient_hid" type="varchar(20)"/>
            <column name="encounter_id" type="varchar(50)"/>
            <column name="descr" type="varchar(100)"/>
            <column name="code" type="varchar(20)"/>
            <column name="uuid" type="varchar(50)"/>
            <column name="incident_uuid" type="varchar(50)"/>
            <column name="date_created" type="datetime" defaultValueComputed="CURRENT_TIMESTAMP" />
        </createTable>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150619-1226" author="sharedhealth" context="setup">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="idx_concept_concept_uuid"/>
            </not>
        </preConditions>
        <createIndex indexName="idx_concept_concept_uuid"
                     tableName="concept">
            <column name="concept_uuid" type="varchar(50)"/>
        </createIndex>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150619-1227" author="sharedhealth" context="setup">
        <comment>Change reference term name column size to 100 from 255</comment>
        <modifyDataType tableName="reference_term" columnName="name" newDataType="varchar(100)" />
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150619-1228" author="sharedhealth" context="setup">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="idx_reference_term_code"/>
            </not>
        </preConditions>
        <createIndex indexName="idx_reference_term_code" tableName="reference_term">
            <column name="code" type="varchar(50)"/>
        </createIndex>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150619-1229-1" author="sharedhealth" context="setup">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="idx_reference_term_map_concept_uuid"/>
            </not>
        </preConditions>
        <createIndex indexName="idx_reference_term_map_concept_uuid" tableName="reference_term_map">
            <column name="concept_uuid" type="varchar(50)"/>
        </createIndex>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150619-1229-2" author="sharedhealth" context="setup">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="idx_reference_term_map_reference_term_uuid"/>
            </not>
        </preConditions>
        <createIndex indexName="idx_reference_term_map_reference_term_uuid" tableName="reference_term_map">
            <column name="reference_term_uuid" type="varchar(50)"/>
        </createIndex>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150619-1257-1" author="sharedhealth" context="setup">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="idx_diagnosis_encounter_id"/>
            </not>
        </preConditions>
        <createIndex indexName="idx_diagnosis_encounter_id" tableName="diagnosis">
            <column name="encounter_id" type="varchar(50)"/>
        </createIndex>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150619-1257-2" author="sharedhealth" context="setup">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="idx_diagnosis_diagnosis_datetime"/>
            </not>
        </preConditions>
        <createIndex indexName="idx_diagnosis_diagnosis_datetime" tableName="diagnosis">
            <column name="diagnosis_datetime" type="datetime"/>
        </createIndex>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150619-1257-3" author="sharedhealth" context="setup">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="idx_diagnosis_diagnosis_code"/>
            </not>
        </preConditions>
        <createIndex indexName="idx_diagnosis_diagnosis_code" tableName="diagnosis">
            <column name="diagnosis_code" type="varchar(10)"/>
        </createIndex>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150619-1303" author="sharedhealth" context="setup">
        <comment>Change drug.reference_term_uuid column size to 50 from 255 and drug name to 100</comment>
        <modifyDataType tableName="drug" columnName="reference_term_uuid" newDataType="varchar(50)" />
        <modifyDataType tableName="drug" columnName="name" newDataType="varchar(100)" />
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150619-1309-3" author="sharedhealth" context="setup">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="idx_drug_reference_term_uuid"/>
            </not>
        </preConditions>
        <createIndex indexName="idx_drug_reference_term_uuid" tableName="drug">
            <column name="reference_term_uuid" type="varchar(50)"/>
        </createIndex>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150619-1427-1" author="sharedhealth" context="setup">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="idx_encounter_encounter_datetime"/>
            </not>
        </preConditions>
        <createIndex indexName="idx_encounter_encounter_datetime" tableName="encounter">
            <column name="encounter_datetime" type="datetime"/>
        </createIndex>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150619-1427-2" author="sharedhealth" context="setup">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="idx_encounter_facility_id"/>
            </not>
        </preConditions>
        <createIndex indexName="idx_encounter_facility_id" tableName="encounter">
            <column name="facility_id" type="varchar(20)"/>
        </createIndex>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150619-1430-1" author="sharedhealth" context="setup">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="idx_immunization_reason_incident_uuid"/>
            </not>
        </preConditions>
        <createIndex indexName="idx_immunization_reason_incident_uuid" tableName="immunization_reason">
            <column name="incident_uuid" type="varchar(50)"/>
        </createIndex>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150619-1430-2" author="sharedhealth" context="setup">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="idx_immunization_reason_code"/>
            </not>
        </preConditions>
        <createIndex indexName="idx_immunization_reason_code" tableName="immunization_reason">
            <column name="code" type="varchar(20)"/>
        </createIndex>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150619-1430-3" author="sharedhealth" context="setup">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="idx_immunization_reason_encounter_id"/>
            </not>
        </preConditions>
        <createIndex indexName="idx_immunization_reason_encounter_id" tableName="immunization_reason">
            <column name="encounter_id" type="varchar(50)"/>
        </createIndex>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150619-1439-1" author="sharedhealth" context="setup">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="idx_medication_datetime"/>
            </not>
        </preConditions>
        <createIndex indexName="idx_medication_datetime" tableName="medication">
            <column name="datetime" type="datetime"/>
        </createIndex>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150619-1439-2" author="sharedhealth" context="setup">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="idx_medication_drug_id"/>
            </not>
        </preConditions>
        <createIndex indexName="idx_medication_drug_id" tableName="medication">
            <column name="drug_id" type="varchar(50)"/>
        </createIndex>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150619-1441-1" author="sharedhealth" context="setup">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="idx_observation_datetime"/>
            </not>
        </preConditions>
        <createIndex indexName="idx_observation_datetime" tableName="observation">
            <column name="datetime" type="datetime"/>
        </createIndex>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150619-1442" author="sharedhealth" context="setup">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="date" tableName="procedures"/>
        </preConditions>
        <comment>change procedures table, date column to datetime for consistency</comment>
        <renameColumn columnDataType="datetime"
                      oldColumnName="date"
                      newColumnName="datetime"
                      tableName="procedures"/>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150619-1443-1" author="sharedhealth" context="setup">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="idx_procedures_datetime"/>
            </not>
        </preConditions>
        <createIndex indexName="idx_procedures_datetime" tableName="procedures">
            <column name="datetime" type="datetime"/>
        </createIndex>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150722-1147" author="sanjana">
        <comment>Adding metadata columns to patient table</comment>
        <addColumn tableName="patient">
            <column name="created_at" type="datetime" defaultValueComputed="now()"/>
            <column name="updated_at" type="datetime" defaultValueComputed="now()"/>
        </addColumn>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150818-1513" author="sanjana" context="setup">
        <comment>Dropping patient age columns in encounter table</comment>
        <dropColumn columnName="patient_age_years" tableName="encounter"/>
        <dropColumn columnName="patient_age_months" tableName="encounter"/>
        <dropColumn columnName="patient_age_days" tableName="encounter"/>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20150818-1520" author="sanjana" context="setup">
        <comment>Dropping patient age columns in encounter table</comment>
        <dropColumn columnName="patient_age_years" tableName="patient_death_details"/>
        <dropColumn columnName="patient_age_months" tableName="patient_death_details"/>
        <dropColumn columnName="patient_age_days" tableName="patient_death_details"/>
    </changeSet>

    <changeSet id="sharedhealth-datasense-20151007-1200" author="Angshu" context="setup">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="retries" tableName="failed_events"/>
            </not>
        </preConditions>
        <addColumn tableName="failed_events">
            <column name="retries" type="int" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20151007-1202" author="Angshu" context="setup">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="failed_event_retry_log"/>
            </not>
        </preConditions>
        <createTable tableName="failed_event_retry_log">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="feed_uri" type="varchar(255)"/>
            <column name="failed_at" type="datetime"/>
            <column name="error_message" type="TEXT"/>
            <column name="event_id" type="varchar(255)"/>
            <column name="event_content" type="TEXT"/>
            <column name="error_hash_code" type="int"/>
        </createTable>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20151007-1346" author="Angshu" context="setup">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="param_config"/>
            </not>
        </preConditions>
        <createTable tableName="param_config">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="param_name" type="varchar(50)">
                <constraints unique="true"/>
            </column>
            <column name="param_value" type="varchar(255)"/>
            <column name="param_type" type="varchar(20)"/>
            <column name="data_type" type="varchar(20)"/>
        </createTable>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20151007-1746" author="Angshu" context="config">
        <sql>
            INSERT INTO param_config (param_name, param_value, param_type, data_type) SELECT * FROM (SELECT 'DATE_OF_DEATH_UUID', 'NEED-TO-CONFIGURE', 'SYSTEM', 'String') AS tmp
            WHERE NOT EXISTS (SELECT param_name FROM param_config WHERE param_name = 'DATE_OF_DEATH_UUID' ) LIMIT 1;

            INSERT INTO param_config (param_name, param_value, param_type, data_type) SELECT * FROM (SELECT 'DEATH_CODES', 'NEED-TO-CONFIGURE', 'SYSTEM', 'String') AS tmp
            WHERE NOT EXISTS (SELECT param_name FROM param_config WHERE param_name = 'DEATH_CODES' ) LIMIT 1;

            INSERT INTO param_config (param_name, param_value, param_type, data_type) SELECT * FROM (SELECT 'CIRCUMSTANCES_OF_DEATH_UUID', 'NEED-TO-CONFIGURE', 'SYSTEM', 'String') AS tmp
            WHERE NOT EXISTS (SELECT param_name FROM param_config WHERE param_name = 'CIRCUMSTANCES_OF_DEATH_UUID' ) LIMIT 1;

            INSERT INTO param_config (param_name, param_value, param_type, data_type) SELECT * FROM (SELECT 'CAUSE_OF_DEATH_UUID', 'NEED-TO-CONFIGURE', 'SYSTEM', 'String') AS tmp
            WHERE NOT EXISTS (SELECT param_name FROM param_config WHERE param_name = 'CAUSE_OF_DEATH_UUID' ) LIMIT 1;
        </sql>
    </changeSet>
    <changeSet id="sharedhealth-datasense-20151026-1818" author="sharedhealth" context="setup">
        <comment>Change reference term and drug name column size to 255 from 100</comment>
        <modifyDataType tableName="reference_term" columnName="name" newDataType="varchar(255)" />
        <modifyDataType tableName="drug" columnName="name" newDataType="varchar(255)" />
    </changeSet>
    <changeSet id="sharedhealth-datasense-20151109-1818" author="sharedhealth" context="setup">
        <comment>Change event content column type</comment>
        <modifyDataType tableName="failed_events" columnName="event_content" newDataType="mediumtext" />
    </changeSet>
</databaseChangeLog>